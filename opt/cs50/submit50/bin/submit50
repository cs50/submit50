#!/bin/bash

# exit on ctrl-c
trap cancel INT
function cancel()
{
    stty echo
    echo
    echo -e -n "\033[31m"
    echo "Submission cancelled."
    echo -e -n "\033[39m"
    exit
}

# usage 
if [[ $# -ne 1 ]]; then
    echo "Usage: submit50 problem"
    exit
fi
problem="$1"

# dependencies
for cmd in curl expect jq sed; do
    if ! command -v "$cmd" > /dev/null 2>&1; then
        echo "Missing dependency. Install \`$cmd\`."
        exit 1
    fi
done

# ensure problem exists
EXCLUDE=$(mktemp)
if [[ $? -ne 0 ]]; then
    echo "Could not create a temporary file."
    exit 1
fi
curl --fail -o "$EXCLUDE" --silent "https://raw.githubusercontent.com/submit50/submit50/$problem/exclude"
if [[ $? -ne 0 ]]; then
    echo "Invalid problem. Did you mean to submit something else?"
    rm -f "$EXCLUDE"
    exit 1
fi

# check for missing files 
declare -a files
while read line; do
    if [[ "$line" =~ ^# ]]; then
        file=$(sed 's/^[ \t]*//;s/[ \t]*$//' <<< "${line#?}")
        if [[ ! -e "$file" ]]; then
            files+=("$file")
        fi
        unset file
    fi
done < "$EXCLUDE"
unset line
if [[ ${#files[@]} -ne 0 ]]; then
    echo "You seem to be missing these files:"
    printf " %s\n" "${files[@]}"
    read -p "Proceed anyway? " -r read
    shopt -s nocasematch
    if [[ ! "$read" =~ ^\s*(yes|y)\s*$ ]]; then
        echo -e -n "\033[31m"
        echo "Submission cancelled."
        echo -e -n "\033[39m"
        rm -f "$EXCLUDE"
        exit 1
    fi
    shopt -u nocasematch
fi

# ask for GitHub username
while read -p "GitHub username: " -r username
do
    if [[ ! -z "$username" ]]; then
        break
    fi
done

# ask for GitHub password
# http://stackoverflow.com/a/1923893
# http://askubuntu.com/a/299469
while true
do
    prompt="GitHub password: "
    while IFS= read -p "$prompt" -r -s -n 1 char
    do
        if [[ "$char" == $'\0' ]]; then
            break
        fi
        if [[ "$char" == $'\177' ]]; then
            if [[ ${#password} -gt 0 ]]; then
                prompt=$'\b \b'
                password="${password%?}"
            else
                prompt=''
            fi
        else
            prompt='*'
            password+="$char"
        fi
    done
    echo
    if [[ ! -z "$password" ]]; then
        break
    fi
done
unset prompt

# HEAD https://api.github.com/user
headers=$(curl --config - --fail --head --silent "https://api.github.com/user" <<< "user = $username:$password" 2>&1)
if [[ $? -ne 0 ]]; then
    echo "Incorrect GitHub username and/or password!"
    echo "Visit https://github.com/password_reset if forgotten."
    rm -f "$EXCLUDE"
    exit 1
fi
datetime=$(sed -nr "s/^Date: (.*)/\1/p" <<< "$headers")
if [[ -z "$datetime" ]]; then
    echo "Can't figure out what time it is!"
    echo "Let sysadmins@cs50.harvard.edu know!"
    rm -f "$EXCLUDE"
    exit 1
fi

# GET https://api.github.com/user
user=$(curl --config - --fail --silent "https://api.github.com/user" <<< "user = $username:$password" 2>&1)
if [[ $? -ne 0 ]]; then
    echo "Sorry, something's wrong!"
    echo "Let sysadmins@cs50.harvard.edu know!"
    rm -f "$EXCLUDE"
    exit
fi
name=$(jq --raw-output '.name // empty' <<< "$user")
login=$(jq --raw-output '.login // empty' <<< "$user")
if [[ ! -z "$login" ]]; then
    username="$login"
fi
unset login
unset user

# GET https://api.github.com/user/emails
emails=$(curl --config - --fail --silent "https://api.github.com/user/emails" <<< "user = $username:$password" 2>&1)
if [[ $? -ne 0 ]]; then
    echo "Sorry, something's wrong!"
    echo "Let sysadmins@cs50.harvard.edu know!"
    rm -f "$EXCLUDE"
    exit
fi
verified=$(jq --raw-output '.[] | select(.primary == true) | .verified' <<< "$emails")
if [[ "$verified" != "true" ]]; then
    echo "Looks like you still need to verify your email address at https://github.com/settings/emails!"
    rm -f "$EXCLUDE"
    exit
fi
email=$(jq --raw-output '.[] | select(.primary == true) | .email // empty' <<< "$emails")
unset verified
unset emails

# GET https://api.github.com/submit50/$username
curl --config - --fail --head --silent "https://api.github.com/repos/submit50/$username" <<< "user = $username:$password" > /dev/null 2>&1
if [[ $? -ne 0 ]]; then
    echo "Looks like we haven't enabled submit50 for your account yet!"
    echo "Let sysadmins@cs50.harvard.edu know your GitHub username!"
    rm -f "$EXCLUDE"
    exit
fi

# path to the repository
GIT_DIR=$(mktemp -d)
if [[ $? -ne 0 ]]; then
    echo "Could not create a temporary directory."
    rm -f "$EXCLUDE"
    exit 1
fi
export GIT_DIR

# path to the working tree
export GIT_WORK_TREE="$PWD"

# git clone --bare https://github.com/submit50/$username
echo -e -n "\033[33m"
echo "git clone --bare https://github.com/submit50/$username"
echo -e -n "\033[39m"
expect <<- EOF
    spawn git clone --bare "https://$username@github.com/submit50/$username" "$GIT_DIR"
    expect {
        "*Password*:" { send -- {$password}; send -- "\n"; expect eof }
        eof { exit }
    }
EOF
if [[ $? -ne 0 ]]; then
    echo "Could not clone https://$username@github.com/submit50/$username"
    rm -rf "$GIT_DIR"
    rm -f "$EXCLUDE"
    exit 1
fi

# set options
# https://help.github.com/articles/keeping-your-email-address-private/
git config user.email "${email:-$username@users.noreply.github.com}"
git config user.name "${name:-$username}"

# updates HEAD to point at $problem
git symbolic-ref HEAD "refs/heads/$problem"

# patterns of file names to exclude
git config core.excludesFile "$EXCLUDE"
git config core.ignorecase true

# adds, modifies, and removes index entries to match the working tree
echo -e -n "\033[33m"
echo "git add --all"
echo -e -n "\033[39m"
git add --all

# files that will be submitted
files=$(git ls-files | sed -e 's/^/ /')
if [[ -z "$files" ]]; then
    echo "None of the files in this directory are expected for submission."
    echo -e -n "\033[31m"
    echo "Submission cancelled."
    echo -e -n "\033[39m"
    rm -rf "$GIT_DIR"
    rm -f "$EXCLUDE"
    exit 1
fi
echo "Files that will be submitted:"
echo "$files"
unset files

# files that won't be submitted
files=$(git ls-files --other | sed -e 's/^/ /')
if [[ ! -z "$files" ]]; then
    echo "Files that won't be submitted:"
    echo "$files"
fi
unset files
read -p "Submit? " -r read
shopt -s nocasematch
if [[ ! "$read" =~ ^\s*(yes|y)\s*$ ]]; then
    echo -e -n "\033[31m"
    echo "Submission cancelled."
    echo -e -n "\033[39m"
    rm -rf "$GIT_DIR"
    rm -f "$EXCLUDE"
    exit 1
fi
shopt -u nocasematch

# stores the current contents of the index in a new commit
echo -e -n "\033[33m"
echo "git commit"
echo -e -n "\033[39m"
git commit --allow-empty --message="$datetime"

# updates remote refs using local refs, while sending objects necessary
echo -e -n "\033[33m"
echo "git push origin $problem"
echo -e -n "\033[39m"
expect <<- EOF
    spawn git push origin "refs/heads/$problem"
    expect {
        "*Password*:" { send -- {$password}; send -- "\n"; expect eof }
        eof { exit }
    }
EOF

# TODO: don't hardcode branch name
# create a new orphan branch and switch to it 
echo -e -n "\033[33m"
echo "git checkout --orphan orphan"
echo -e -n "\033[39m"
git checkout --orphan "orphan"

# adds, modifies, and removes index entries to match the working tree
echo -e -n "\033[33m"
echo "git add --all"
echo -e -n "\033[39m"
git add --all

# stores the current contents of the index in a new commit
echo -e -n "\033[33m"
echo "git commit"
echo -e -n "\033[39m"
git commit --allow-empty --message="$datetime"

# add a tag reference
echo -e -n "\033[33m"
echo "git tag --force $problem"
echo -e -n "\033[39m"
git tag --force "$problem"

# updates remote refs using local refs, while sending objects necessary
echo -e -n "\033[33m"
echo "git push --force origin refs/tags/$problem"
echo -e -n "\033[39m"
expect <<- EOF
    spawn git push --force origin "refs/tags/$problem"
    expect {
        "*Password*:" { send -- {$password}; send -- "\n"; expect eof }
        eof { exit }
    }
EOF

# remove temporaries
rm -rf "$GIT_DIR"
rm -f "$EXCLUDE"

# kthxbai
echo -e -n "\033[32m"
echo "Submitted $problem! See https://github.com/submit50/$username/releases/tag/$problem."
echo -e -n "\033[39m"
